name: Uber_Backend_Workflow (Docker Compose)

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    env:
      HAS_DOCKERHUB_CREDS: ${{ secrets.DOCKERHUB_USERNAME != '' && secrets.DOCKERHUB_TOKEN != '' }}

    steps:
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ“¦ Install test dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y netcat-openbsd

      - name: ðŸ” Log in to DockerHub
        if: env.HAS_DOCKERHUB_CREDS == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: â„¹ï¸ DockerHub credentials status
        run: |
          if [ "${HAS_DOCKERHUB_CREDS}" = "true" ]; then
            echo "DockerHub credentials detected."
          else
            echo "DockerHub credentials not provided. Proceeding without registry login."
          fi

      - name: ðŸ³ Start Docker Compose stack
        run: docker compose --env-file .env -f docker/docker-compose.yml up --build -d

      - name: â™»ï¸ Prepare test user credentials
        run: echo "TEST_USERNAME=testuser-$RANDOM" >> "$GITHUB_ENV"

      - name: â±ï¸ Wait for services to initialize
        run: |
          timeout 420 bash -c '
            until [ "$(docker compose --env-file .env -f docker/docker-compose.yml ps --status running --services | wc -l)" -ge 9 ]; do
              echo "Waiting for application services to enter the running state..."
              sleep 10
            done
          '

      - name: ðŸ”Ž Wait for critical ports
        run: |
          for port in 3307 3308 3309 5672 8081 8082 8083 9092; do
            echo "Waiting for port ${port}..."
            timeout 420 bash -c "until nc -z localhost ${port}; do sleep 5; done"
          done

      - name: âœ… Wait for UserManager health endpoint
        run: |
          set -euo pipefail
          deadline=$((SECONDS + 420))

          while [ "$SECONDS" -lt "$deadline" ]; do
            if response=$(curl --silent --show-error --fail --connect-timeout 5 http://localhost:8081/health 2>/dev/null); then
              if python3 -c "import json,sys; data=json.load(sys.stdin); sys.exit(0 if data.get('database', {}).get('healthy') else 1)" <<<"${response}"; then
                echo "UserManager health check passed."
                exit 0
              fi
              echo "Health endpoint reachable but database not yet healthy." >&2
            else
              echo "Waiting for health endpoint..." >&2
            fi

            sleep 5
          done

          echo "Timed out waiting for UserManager health endpoint to become healthy." >&2
          exit 1

      - name: âœ… Test - All containers are running
        run: |
          docker ps
          docker ps --format '{{.Names}}' | grep -Fx usermanager
          docker ps --format '{{.Names}}' | grep -Fx ridemanager
          docker ps --format '{{.Names}}' | grep -Fx locationmanager

      - name: ðŸªµ Print MySQL logs (debug)
        if: failure()
        run: |
          docker logs usermanager-db
          docker logs ridemanager-db
          docker logs locationmanager-db

      - name: âœ… Test - MySQL ports open
        run: |
          nc -z localhost 3307
          nc -z localhost 3308
          nc -z localhost 3309

      - name: âœ… Test - Application ports open
        run: |
          nc -z localhost 8081
          nc -z localhost 8082
          nc -z localhost 8083

      - name: âœ… Test - POST /signup HTTP endpoint
        run: |
          curl --fail --retry 5 --retry-delay 5 --retry-connrefused -X POST http://localhost:8081/signup \
            -H "Content-Type: application/json" \
            -d '{
              "firstName": "firstName",
              "middleName": "middleName",
              "lastName": "lastName",
              "mobileNumber": "123456789",
              "address": "123 Test St",
              "email": "test@example.com",
              "username": "'"${TEST_USERNAME}"'",
              "password": "testpass",
              "role": "rider"
            }'

      - name: âœ… Test - POST /login HTTP endpoint
        run: |
          curl --fail --retry 5 --retry-delay 5 --retry-connrefused -X POST http://localhost:8081/login \
            -H "Content-Type: application/json" \
            -d '{"username": "'"${TEST_USERNAME}"'", "password": "testpass"}'

      - name: âœ… Test - Kafka port
        run: nc -z localhost 9092

      - name: ðŸ“¦ Clean up
        if: always()
        run: docker compose --env-file .env -f docker/docker-compose.yml down -v
