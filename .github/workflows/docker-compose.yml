name: Docker Compose CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  docker-compose:
    runs-on: ubuntu-latest

    steps:
      - name: üßæ Checkout Repository
        uses: actions/checkout@v3

      - name: üê≥ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üêô Set up Docker Compose
        uses: docker/setup-docker-compose@v2

      - name: üß™ Verify .env file exists
        run: |
          if [ ! -f .env ]; then
            echo ".env file is missing. Creating a dummy one for CI..."
            cat <<EOF > .env
MYSQL_ROOT_PASSWORD=root
MYSQL_USER=uber
MYSQL_PASSWORD=pass
USERMANAGER_DB=userdb
RIDEMANAGER_DB=ridedb
LOCATIONMANAGER_DB=locationdb
USERMANAGER_PORT=3307
RIDEMANAGER_PORT=3308
LOCATIONMANAGER_PORT=3309
USERMANAGER_APP_PORT=8081
RIDEMANAGER_APP_PORT=8082
LOCATIONMANAGER_APP_PORT=8083
EOF
          fi

      - name: üîß Build and Start All Services
        run: docker-compose -f docker/docker-compose.yml up --build -d

      - name: ‚è≥ Wait for Containers to Initialize
        run: sleep 20

      - name: üìã List Running Containers
        run: docker ps

      - name: üì• Fetch Logs (UserManager)
        run: docker logs UserManager || true

      # Optionally, check if health endpoint is up
      - name: ‚úÖ Health Check (optional)
        run: |
          curl --fail http://localhost:8081/health || echo "Health check failed"

      - name: üßπ Tear Down
        if: always()
        run: docker-compose -f docker/docker-compose.yml down -v
