name: Uber_Backend_Workflow (Docker Compose)

on:
  push:
    branches:
      - main

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: ‚¨áÔ∏è Checkout repository
        uses: actions/checkout@v3

      - name: ‚öôÔ∏è Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üîê Log in to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: üê≥ Start Docker Compose stack
        run: docker compose -f docker/docker-compose.yml up --build -d

      - name: ‚è±Ô∏è Wait for services to initialize (10 minutes)
        run: sleep 600

      - name: ‚úÖ Test - All containers are running
        run: |
          docker ps
          docker ps | grep UserManager
          docker ps | grep RideManager
          docker ps | grep LocationManager

      - name: ‚úÖ Test - MySQL ports open
        run: |
          nc -z localhost 3307
          nc -z localhost 3308
          nc -z localhost 3309

      - name: ‚úÖ Test - Application ports open
        run: |
          nc -z localhost 8081
          nc -z localhost 8082
          nc -z localhost 8083

      - name: ‚úÖ Test - POST /signup HTTP endpoint
        run: |
          curl --fail -X POST http://localhost:8081/signup \
            -H "Content-Type: application/json" \
            -d '{
              "firstName": "firstName",
              "middleName": "middleName",
              "lastName": "lastName",
              "mobileNumber": "123456789",
              "address": "123 Test St",
              "email": "test@example.com",
              "username": "testuser",
              "password": "testpass",
              "role": "rider"
            }' || echo "‚ùå /signup failed"

      - name: ‚úÖ Test - POST /login HTTP endpoint
        run: |
          curl --fail -X POST http://localhost:8081/login \
            -H "Content-Type: application/json" \
            -d '{"username": "testuser", "password": "testpass"}' || echo "‚ùå /login failed"

      - name: ‚úÖ Test - Kafka port
        run: nc -z localhost 9092

      - name: üì¶ Clean up
        if: always()
        run: docker compose -f docker/docker-compose.yml down -v