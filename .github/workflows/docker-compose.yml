name: Docker Compose CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  docker-compose:
    runs-on: ubuntu-latest

    steps:
      - name: üßæ Checkout Repository
        uses: actions/checkout@v3

      - name: üê≥ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üß™ Create .env if missing
        run: |
          if [ ! -f .env ]; then
            echo "Creating dummy .env file for CI..."
            cat <<EOF > .env
          MYSQL_ROOT_PASSWORD=root
          MYSQL_USER=pasan
          MYSQL_PASSWORD=pasan
          
          USERMANAGER_DB=userManagerDatabase
          USERMANAGER_PORT=3307
          USERMANAGER_APP_PORT=8081
          
          RIDEMANAGER_DB=rideManagerDatabase
          RIDEMANAGER_PORT=3308
          RIDEMANAGER_APP_PORT=8082
          
          LOCATIONMANAGER_DB=locationManagerDatabase
          LOCATIONMANAGER_PORT=3309
          LOCATIONMANAGER_APP_PORT=8083
          EOF
          fi

      - name: üîß Build and Start All Services
        run: docker compose -f docker/docker-compose.yml up --build -d

      - name: ‚è≥ Wait for Containers to Initialize
        run: sleep 20

      - name: üìã List Running Containers
        run: docker ps

      - name: üì• Fetch Logs (UserManager)
        run: docker logs UserManager || true

      - name: ‚úÖ Health Check (optional)
        run: |
          curl --fail http://localhost:8081/health || echo "Health check failed"

      - name: üßπ Tear Down
        if: always()
        run: docker compose -f docker/docker-compose.yml down -v
